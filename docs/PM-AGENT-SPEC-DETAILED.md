# PM-Agent 可執行規格書（詳細版）

> 本文件為「可執行階段」規格：涵蓋 Intake & Analysis、QA Backlog、Architecture & Stories、PRD、File Records、會議記錄與備忘錄，以及所有優化功能。細至子功能、驗收條件、關聯、漏洞與修正、實作階段建議。**不修改現有程式碼，僅作為開發依據。**

---

## 0. 文件說明與使用方式

### 0.1 目的

- 將產品構想收斂為**可拆任務、可驗收**的規格。
- 明確**實體關聯**與**資料流**，避免遺漏與矛盾。
- 標註**漏洞與邊界**並給出決策，供實作時直接遵循。
- 提供**階段順序**與依賴，方便排程與 Sprint 規劃。

### 0.2 讀者與用法

- **PM**：依此驗收、補需求、調整優先級。
- **開發**：依此拆 API / 資料表 / 前後端 Task，對應到章節編號（如 IA-1、QB-2）。
- **QA**：依「驗收條件」撰寫測試案例。

### 0.3 名詞對照

| 英文/簡稱 | 中文 | 說明 |
|-----------|------|------|
| Intake | 單筆 Intake 紀錄 | 一筆「音檔 → 轉錄 → 分析」的完整產出紀錄 |
| File / File Record | 檔案紀錄 | 上傳的原始檔案一筆 |
| QA Item | QA 項目 | QA Backlog 中的一筆待辦／雜項 |
| Story | 故事 | Architecture & Stories 中的一條使用者故事或架構條目 |
| Meeting Note | 會議記錄 | 從 Intake 一鍵生成並可編輯的結構化會議記錄 |
| Memo | 備忘錄 | 從 Intake 一鍵生成並可編輯的輕量備忘 |
| PRD Version | PRD 版本 | 一次存版的 PRD 完整內容 |

---

## 1. 實體與關聯總覽

### 1.1 核心實體（邏輯）

```
File (檔案)
  └── 可關聯 → Intake（一檔可對多筆 Intake，若重複分析）

Intake (AI 處理紀錄)
  ├── 關聯 → File（來源檔，可選）
  ├── 關聯 → MeetingNote[] / Memo[]（由此生成的會議記錄／備忘錄）
  ├── 關聯 → QA Item[]（由此加入的 QA 項目）
  └── 可建議 → Architecture / Story（手動或半自動寫入）

MeetingNote / Memo (會議記錄／備忘錄)
  ├── 關聯 → Intake（來源）
  └── 可關聯 → QA Item[]（標註對應的 QA）

QA Item (QA 項目)
  ├── 關聯 → Intake（來源，可選）
  ├── 關聯 → MeetingNote（可選，若從會議記錄標註）
  └── 可同步 → Architecture / Story

Architecture & Stories (專案層)
  ├── 條目可標註來源：Intake / QA Item
  └── 可被 PRD 選為素材

PRD (產品需求文件)
  ├── 多版本（PRD Version）
  └── 每版可引用：Intake 摘要、QA、Architecture 段落、會議記錄段落等
```

### 1.2 關聯矩陣（誰可連到誰）

| 從 \ 到 | File | Intake | MeetingNote/Memo | QA Item | Arch/Story | PRD |
|---------|------|--------|------------------|---------|------------|-----|
| File | - | 列出「由此產生的 Intake」 | - | - | - | - |
| Intake | 顯示來源 File | - | 一鍵生成 | 加入 QA | 建議寫入 | 被選為 PRD 素材 |
| MeetingNote/Memo | - | 顯示來源 Intake | - | 標註對應 QA | - | 被選為 PRD 素材 |
| QA Item | - | 顯示來源 Intake | 可標註 | - | 同步到 Arch/Story | 被選為 PRD 素材 |
| Arch/Story | - | 標註來源 | - | - | - | 被選為 PRD 素材 |
| PRD | - | 選料來源 | 選料來源 | 選料來源 | 選料來源 | 版本之間 diff |

### 1.3 資料流簡圖

```
上傳音檔 → File
     ↓
轉錄+分析 → Intake（關聯 File）
     ↓
     ├→ 一鍵生成 → MeetingNote / Memo
     ├→ 加入 → QA Item（雙向關聯 Intake）
     └→ 建議寫入 → Architecture / Story

QA Item 結案/收斂 → 可同步 → Architecture / Story

PRD：從 Intake、MeetingNote、QA、Arch/Story 選料 → AI 整理 → 草稿 → 存版
```

---

## 2. File Records（檔案庫）

### 2.1 目標與範圍

- **目標**：集中管理所有上傳檔案（音檔、文件、圖片等），提供列表、篩選、下載、預覽、刪除，並在 UI 上能看出「哪些檔案已有 Intake 紀錄」。
- **範圍**：不負責轉錄／分析邏輯，僅負責檔案 CRUD 與展示；Intake 模組負責「處理紀錄」與關聯。

### 2.2 子功能清單（細至可驗收）

#### FR-1 列表與展示

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| FR-1.1 | 列表欄位 | 顯示：檔名、檔案類型、大小、上傳時間、上傳者（若有）、所屬專案/業務（若有） |
| FR-1.2 | 音檔標記 | 若該 File 有關聯的 Intake 紀錄，顯示「已分析」或圖示，可點擊跳轉至該 Intake |
| FR-1.3 | 分頁 | 支援分頁，每頁筆數可選（如 20/50），顯示總筆數 |
| FR-1.4 | 排序 | 支援依上傳時間、檔名、大小、類型排序，升序/降序可切換 |

#### FR-2 篩選與搜尋

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| FR-2.1 | 依類型篩選 | 可篩：全部 / 音檔 / 文件 / 圖片（依 MIME 或副檔名） |
| FR-2.2 | 依專案/業務篩選 | 若系統有 Project / BusinessType，可依其篩選 |
| FR-2.3 | 依「是否已分析」篩選 | 可篩：全部 / 已有 Intake / 尚未分析（僅音檔有意義） |
| FR-2.4 | 關鍵字搜尋 | 對檔名做關鍵字搜尋（前後端皆可，依實作選擇） |

#### FR-3 上傳

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| FR-3.1 | 單檔上傳 | 選擇單一檔案上傳，支援類型與大小限制（沿用現有設定） |
| FR-3.2 | 多檔上傳 | 可一次選擇多檔上傳，各自進度與結果獨立 |
| FR-3.3 | 上傳後行為 | 上傳成功後可選：僅存檔，或若為音檔則「建立 Intake 並開始轉錄」（與現有流程一致） |
| FR-3.4 | 重複檔策略 | 若支援「依 hash 去重」，需明確：覆寫同檔或新檔＋關聯同一 File（規格先訂一種，避免漏洞） |

#### FR-4 下載、預覽、刪除

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| FR-4.1 | 下載 | 點擊下載取得原始檔案，檔名與上傳時一致（或安全處理過） |
| FR-4.2 | 預覽 | 圖片／PDF 可於頁面內預覽；音檔可播放（若已有） |
| FR-4.3 | 刪除 | 軟刪除或硬刪除（依現有設計）；刪除前若有 Intake 關聯，需提示「將保留 Intake 紀錄，但無法再從 File 跳回原檔」或「一併隱藏 Intake」（見漏洞 9.1） |

### 2.3 資料欄位（建議最小集）

- `id`, `fileName`, `originalFilename`, `mimeType`, `size`, `storagePath`, `hash`（可選）, `projectId` / `businessType` / `businessId`（可選）, `uploadedBy`, `createdAt`, `deletedAt`（若軟刪）.

### 2.4 與他模組關聯

- **→ Intake**：查詢「此 File 的 Intake 紀錄」用於列表標記與跳轉。
- **← Intake**：Intake 建立時寫入 `sourceFileId`（可選），File 刪除策略需與 Intake 一致（見 9.1）。

### 2.5 邊界與漏洞處理

- **漏洞 FR-A**：刪除 File 後，關聯的 Intake 若仍存在，逐字稿/分析仍在，但「下載原檔」不可用。**決策**：刪除 File 時不自動刪 Intake；Intake 詳情頁若來源檔已刪除，顯示「原始檔已刪除」，隱藏下載按鈕。
- **漏洞 FR-B**：同一音檔多次上傳是否視為同一 File？**決策**：依現有「依 hash 覆寫」或「新 File」策略在規格中寫死一種，並在 FR-3.4 實作一致。

---

## 3. Intake & Analysis（AI 處理紀錄）

### 3.1 目標與範圍

- **目標**：每一筆為「一次完整的音檔 → 轉錄 → AI 分析」的產出；提供列表、詳情（逐字稿＋分析）、以及後續動作（會議記錄／備忘錄、加入 QA、建議寫入 Architecture）。
- **範圍**：列表與詳情由本模組負責；實際轉錄/分析可沿用現有 Whisper + Claude 流程。

### 3.2 子功能清單（細至可驗收）

#### IA-1 列表與展示

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| IA-1.1 | 列表欄位 | 顯示：標題（檔名或 AI 摘要前 N 字）、來源檔名、處理完成時間、狀態（成功/轉錄成功分析失敗/轉錄失敗）、摘要一句（來自分析結果） |
| IA-1.2 | 狀態標示 | 三態明確：成功（綠）、部分成功（黃，僅轉錄）、失敗（紅），且可篩選 |
| IA-1.3 | 分頁與排序 | 分頁、依時間排序（新到舊為預設） |
| IA-1.4 | 專案/空間篩選 | 若有多專案，可依專案或空間篩選 Intake 列表 |

#### IA-2 詳情面板

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| IA-2.1 | 逐字稿區 | 完整顯示轉錄文字；可複製整段；可關鍵字搜尋（頁內 highlight） |
| IA-2.2 | 分析結果區 | 分塊顯示：摘要、關鍵決策、風險、依賴、Logic Flags；每塊可摺疊/展開 |
| IA-2.3 | 來源檔資訊 | 顯示來源 File 檔名、上傳時間；若 File 仍存在可點擊「下載原檔」或「在 File Records 中檢視」 |
| IA-2.4 | 關聯 QA 列表 | 列出「由此 Intake 加入的 QA 項目」，每條可點擊跳轉至 QA 詳情 |
| IA-2.5 | 已產出的會議記錄/備忘錄 | 列出由此 Intake 一鍵生成的會議記錄與備忘錄，可點擊進入編輯或檢視 |

#### IA-3 建立與處理流程

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| IA-3.1 | 從上傳建立 | 上傳音檔後可觸發「建立 Intake 並開始轉錄+分析」（與現有流程一致） |
| IA-3.2 | 從 File 建立 | 在 File Records 對已有音檔可操作「建立 Intake／重新分析」，若允許重新分析則建立新 Intake 或覆寫舊 Intake（規格擇一，見 9.2） |
| IA-3.3 | 處理中狀態 | 列表與詳情顯示「轉錄中/分析中」與進度（沿用現有輪詢或狀態 API） |
| IA-3.4 | 失敗重試 | 可對失敗的 Intake 操作「重試轉錄」或「重試分析」（若轉錄已成功僅重試分析） |

#### IA-4 後續動作（入口）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| IA-4.1 | 一鍵生成會議記錄 | 按鈕「生成會議記錄」，可選模板（見會議記錄章），產出後建立一筆 MeetingNote 並關聯此 Intake，跳轉至編輯頁 |
| IA-4.2 | 一鍵生成備忘錄 | 按鈕「生成備忘錄」，產出後建立一筆 Memo 並關聯此 Intake，跳轉至編輯頁 |
| IA-4.3 | 加入 QA Backlog | 按鈕「加入 QA Backlog」，可帶入預填標題/描述（取自摘要或選取段落），建立 QA Item 並建立雙向關聯 |
| IA-4.4 | 建議寫入 Architecture & Stories | 按鈕「建議寫入架構/故事」，開啟選單：勾選要寫入的內容（如摘要、決策、風險），可編輯後送出，在 Architecture 建立條目並標註來源為此 Intake |

#### IA-5 AI 建議（優化）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| IA-5.1 | 分析完成後建議 QA | 分析完成後，可顯示「AI 建議加入的 QA 項目」（條列 1～N 條），使用者可勾選後一鍵加入 QA Backlog |
| IA-5.2 | 分析完成後建議 Architecture | 可顯示「AI 建議寫入架構/故事的要點」，使用者可勾選並編輯後寫入 Architecture & Stories |

### 3.3 資料欄位（建議最小集）

- Intake：`id`, `sourceFileId`（可選）, `projectId`（可選）, `title`, `status`, `transcriptId`, `analysisId`, `createdAt`, `updatedAt`, `createdBy`.
- 轉錄與分析可沿用現有 `FileTranscript` / `FileAnalysis` 或等效結構；Intake 為「紀錄」層，可透過 `fileId` 或直接存 `transcriptId`/`analysisId` 關聯。

### 3.4 與他模組關聯

- **← File**：來源檔；File 刪除時 Intake 保留，但標記或查詢時得知「原檔已刪」。
- **→ MeetingNote / Memo**：一對多；Intake 詳情列出並可跳轉。
- **→ QA Item**：一對多；雙向關聯，Intake 詳情列出 QA，QA 詳情顯示來源 Intake。
- **→ Architecture / Story**：可標註「來自 Intake #id」；不強制外鍵，以來源標註為主。

### 3.5 邊界與漏洞處理

- **漏洞 IA-A**：同一 File 多次分析產生多筆 Intake 時，列表是否都要顯示？**決策**：預設全部顯示，可加篩選「僅顯示最新一筆 per File」供選用。
- **漏洞 IA-B**：轉錄成功但分析永久失敗時，仍可「一鍵生成會議記錄/備忘錄」（僅以逐字稿為依據）。**決策**：允許；按鈕不因分析失敗而禁用。

---

## 4. 會議記錄與備忘錄（Meeting Notes & Memos）

### 4.1 目標與範圍

- **目標**：提供「會議記錄」與「備忘錄」兩種產物；可從 Intake 一鍵生成初稿，再編輯、存版；可與 QA、PRD 關聯。
- **範圍**：獨立功能模組，擁有自己的列表、詳情、編輯、版本（若要做存版）。

### 4.2 子功能清單（細至可驗收）

#### MN-1 會議記錄（Meeting Note）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| MN-1.1 | 建立方式 | (1) 從 Intake 一鍵生成（必選模板）；(2) 手動建立空白 |
| MN-1.2 | 模板選擇 | 一鍵生成時可選：需求討論、合約確認、衝刺回顧、一般會議等；每模板有固定區塊（與會人、結論、待辦、下次會議等） |
| MN-1.3 | 初稿內容 | 以 Intake 的逐字稿 + 分析結果為依據，由 AI 依模板產出結構化初稿（標題、區塊、要點） |
| MN-1.4 | 編輯 | 富文本或 Markdown 編輯器，可修改標題、各區塊內容 |
| MN-1.5 | 存檔與版本 | 存檔即更新；若支援「版本」：每次存檔可選「存為新版本」，並可查看版本列表與 diff（與 PRD 類似但可簡化） |
| MN-1.6 | 關聯 Intake | 必填來源 Intake（一鍵生成時自動帶入）；詳情頁顯示「來源會議/音檔」並可跳轉 |
| MN-1.7 | 關聯 QA | 可選：在會議記錄中標註「對應 QA #id」（一對多），QA 詳情可反向列出「被哪些會議記錄引用」 |
| MN-1.8 | 所屬專案 | 可選所屬專案，方便篩選與時間軸 |

#### MN-2 備忘錄（Memo）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| MN-2.1 | 建立方式 | (1) 從 Intake 一鍵生成（自由格式）；(2) 手動建立空白 |
| MN-2.2 | 初稿內容 | 以 Intake 逐字稿 + 分析為依據，AI 產出簡短重點條列，不強制模板 |
| MN-2.3 | 編輯與存檔 | 輕量編輯（標題 + 內文），存檔即更新；可選是否做版本（與會議記錄策略一致） |
| MN-2.4 | 關聯 Intake | 同 MN-1.6 |
| MN-2.5 | 所屬專案 | 同 MN-1.8 |

#### MN-3 列表與篩選

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| MN-3.1 | 統一列表或分開 | 可為「會議記錄」與「備忘錄」同一列表用類型區分，或分開兩個入口；規格擇一 |
| MN-3.2 | 列表欄位 | 標題、類型（會議記錄/備忘錄）、來源 Intake 標題、建立/更新時間、所屬專案 |
| MN-3.3 | 篩選 | 依類型、專案、時間區間；可選「僅顯示有 Intake 來源的」 |
| MN-3.4 | 搜尋 | 標題與內文關鍵字搜尋（全域搜尋可涵蓋，見 8.2） |

### 4.3 資料欄位（建議）

- 共通：`id`, `type`(meeting_note|memo), `title`, `content`(html/md), `projectId`（可選）, `sourceIntakeId`（可選）, `createdAt`, `updatedAt`, `createdBy`.
- 若做版本：另表 `MeetingNoteVersion` 存 `content`, `versionNumber`, `savedAt` 等。

### 4.4 與他模組關聯

- **← Intake**：來源；Intake 詳情列出「已產出的會議記錄/備忘錄」。
- **→ QA Item**：會議記錄可標註對應 QA（多對多或一對多依實作）。
- **→ PRD**：會議記錄/備忘錄可被選為 PRD 選料來源（見 PRD 章）。

### 4.5 邊界與漏洞處理

- **漏洞 MN-A**：刪除 Intake 後，已產出的會議記錄/備忘錄是否保留？**決策**：保留；`sourceIntakeId` 可為空或保留 id 但顯示「來源 Intake 已刪除」。
- **漏洞 MN-B**：同一 Intake 是否允許多筆會議記錄/備忘錄？**決策**：允許（例如同一會議產出「正式會議記錄」與「簡易備忘」各一筆）。

---

## 5. QA Backlog（PM 雜事清單）

### 5.1 目標與範圍

- **目標**：管理 PM 側雜項（需求確認、合約、發想、請款、待討論等），帶狀態與類型，可追溯來源 Intake／會議記錄。
- **範圍**：清單 CRUD、狀態流轉、篩選、與 Intake/會議記錄/Architecture 的雙向關聯。

### 5.2 子功能清單（細至可驗收）

#### QB-1 列表與展示

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| QB-1.1 | 列表欄位 | 標題、類型（或標籤）、狀態、優先級（可選）、建立時間、來源（來自 Intake / 手動 / 來自會議記錄） |
| QB-1.2 | 來源標示 | 若來自 Intake，顯示 Intake 標題或檔名並可點擊跳轉；若來自會議記錄標註，顯示會議記錄標題並可跳轉 |
| QB-1.3 | 分頁與排序 | 分頁；排序可選：依建立時間、更新時間、狀態、優先級 |
| QB-1.4 | 專案/空間 | 可選所屬專案，列表可依專案篩選 |

#### QB-2 篩選與搜尋

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| QB-2.1 | 依狀態篩選 | 待處理、進行中、已結案、擱置（狀態值需在規格中列舉） |
| QB-2.2 | 依類型篩選 | 需求確認、合約、發想、請款、待討論、跟進、其他（可配置或固定） |
| QB-2.3 | 依是否有音檔來源 | 篩選「有 Intake 來源」/「無」 |
| QB-2.4 | 關鍵字搜尋 | 標題、描述、附註可搜尋 |

#### QB-3 新增與編輯

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| QB-3.1 | 手動新增 | 標題、描述、類型、狀態、優先級、所屬專案可填 |
| QB-3.2 | 從 Intake 加入 | 在 Intake 詳情點「加入 QA Backlog」，可帶入預填標題/描述（可編輯），儲存後建立 QA Item 並寫入 `sourceIntakeId`，Intake 端顯示「已加入 QA」 |
| QB-3.3 | 編輯 | 可修改標題、描述、附註、類型、狀態、優先級、所屬專案 |
| QB-3.4 | 刪除或封存 | 可軟刪除或標記為「已廢棄」，列表可篩選排除已廢棄 |

#### QB-4 詳情與關聯

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| QB-4.1 | 詳情頁 | 顯示完整標題、描述、附註、類型、狀態、優先級、建立/更新時間 |
| QB-4.2 | 來源 Intake | 若有 `sourceIntakeId`，顯示 Intake 標題與連結，點擊可至 Intake 詳情（逐字稿與分析） |
| QB-4.3 | 引用此 QA 的會議記錄 | 若有會議記錄標註「對應此 QA」，列出並可跳轉 |
| QB-4.4 | 已同步至 Architecture | 若此 QA 曾「同步到 Architecture & Stories」，顯示連結至對應條目 |

#### QB-5 狀態流轉與同步

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| QB-5.1 | 狀態變更 | 使用者可手動將狀態改為待處理/進行中/已結案/擱置；可選記錄變更歷史（誰、何時、從哪態到哪態） |
| QB-5.2 | 結案時同步 Architecture | 狀態改為「已結案」或「已收斂」時，可選「同步到 Architecture & Stories」，勾選要寫入的內容（可編輯）後建立/更新 Architecture 條目，並標註來源 QA #id |

### 5.3 資料欄位（建議）

- `id`, `title`, `description`, `notes`, `type`, `status`, `priority`（可選）, `projectId`（可選）, `sourceIntakeId`（可選）, `sourceMeetingNoteId`（可選）, `createdAt`, `updatedAt`, `createdBy`, `deletedAt`（若軟刪）.
- 若做狀態歷史：`QAItemStatusHistory` 表存 `qaItemId`, `fromStatus`, `toStatus`, `changedAt`, `changedBy`.

### 5.4 與他模組關聯

- **← Intake**：來源；雙向：Intake 詳情列 QA，QA 詳情顯示來源 Intake。
- **← MeetingNote**：會議記錄可標註「對應 QA」；QA 詳情列出引用它的會議記錄。
- **→ Architecture / Story**：結案時可同步；Architecture 條目可標註「來自 QA #id」。

### 5.5 邊界與漏洞處理

- **漏洞 QB-A**：刪除 Intake 後，QA 的 `sourceIntakeId` 仍指向已刪 id，連結點擊後如何？**決策**：Intake 軟刪時仍可保留 id；若硬刪則 QA 顯示「來源 Intake 已刪除」，連結隱藏或導向 404 說明。
- **漏洞 QB-B**：同一 Intake 可加入多筆 QA？**決策**：允許；一個會議可產出多個待辦項。

---

## 6. Architecture & Stories（專案層架構與故事）

### 6.1 目標與範圍

- **目標**：專案級的「架構」與「使用者故事」單一真相來源，持續演進；更新來源為手動、Intake 建議、QA 結案同步。
- **範圍**：同一專案下一份或分區（架構區 / 故事區）；條目可標註來源（Intake、QA）；可被 PRD 選為素材。

### 6.2 子功能清單（細至可驗收）

#### AS-1 結構與展示

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| AS-1.1 | 專案維度 | 以專案為維度；Sidebar 選專案後顯示該專案的 Architecture & Stories |
| AS-1.2 | 分區 | 至少兩區：「架構」（技術/模組/介面描述）、「Stories」（功能/使用者故事）；可同頁分區或分 Tab |
| AS-1.3 | 架構區內容 | 支援多條目或一大塊富文本；每條目可標題+內文；可標註「來自 Intake #id」或「來自 QA #id」 |
| AS-1.4 | Stories 區內容 | 每條 Story：標題、描述、可選狀態（構想/已納入/開發中/完成）、優先級；可標註來源 |
| AS-1.5 | 排序與摺疊 | 條目可手動排序；區塊可摺疊/展開 |

#### AS-2 新增與編輯

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| AS-2.1 | 手動新增 | 可在架構區或 Stories 區手動新增條目，填標題、內文、可選來源標註 |
| AS-2.2 | 從 Intake 建議寫入 | 在 Intake 詳情點「建議寫入架構/故事」，勾選要寫入的內容（摘要/決策/風險等），可編輯後送出；在對應區建立條目並寫入 `sourceIntakeId` |
| AS-2.3 | 從 QA 同步 | 在 QA 結案時選「同步到 Architecture & Stories」，內容可編輯，建立條目並寫入 `sourceQAItemId` |
| AS-2.4 | 編輯與刪除 | 可編輯任一條目；可軟刪除或隱藏，並保留來源標註供追溯 |

#### AS-3 關聯與追溯

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| AS-3.1 | 來源標註顯示 | 每條目若有關聯 Intake/QA，顯示「來自會議 xxx」或「來自 QA #id」，可點擊跳轉 |
| AS-3.2 | 與 PRD 對齊（優化） | PRD 章節可連結到某條 Story；在 Architecture 端可顯示「被 PRD 章節 xxx 引用」 |

### 6.3 資料欄位（建議）

- 專案維度：每專案一筆 `ProjectArchitecture` 或拆成「架構塊」+「Story 條目」。
- 架構條目：`id`, `projectId`, `section`(architecture|stories), `title`, `content`, `order`, `sourceIntakeId`（可選）, `sourceQAItemId`（可選）, `createdAt`, `updatedAt`.
- Story 可多欄位：`status`, `priority` 等。

### 6.4 與他模組關聯

- **← Intake**：建議寫入；條目標註來源 Intake。
- **← QA Item**：結案同步；條目標註來源 QA。
- **→ PRD**：條目可被選為 PRD 選料；PRD 與 Story 對齊時可雙向連結（見 7.x）。

### 6.5 邊界與漏洞處理

- **漏洞 AS-A**：同一專案多人同時編輯架構/故事？**決策**：先做樂觀鎖或最後寫入覆蓋，並在規格註明「衝突處理策略」；進階可做 OT/CRDT。
- **漏洞 AS-B**：刪除 Intake 或 QA 後，Architecture 條目的來源標註？**決策**：保留 id，顯示「來源已刪除」或隱藏連結。

---

## 7. PRD（產品需求文件）

### 7.1 目標與範圍

- **目標**：版本控管的需求文件；可從 Intake、會議記錄、QA、Architecture 選料，經 AI 整理成 PRD 草稿，再手動編輯、存版、diff。
- **範圍**：選料 UI、組裝區（草稿編輯）、版本列表、版本 diff、可選「當前對外版本」。

### 7.2 子功能清單（細至可驗收）

#### PRD-1 選料（拼拼湊湊）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| PRD-1.1 | 選料來源 | 從 Intake（摘要/逐字稿段落）、會議記錄（標題+段落）、QA（標題+描述）、Architecture（條目）以清單/卡片勾選 |
| PRD-1.2 | 預覽與順序 | 已選素材可預覽、可調整先後順序、可分組（如：需求來源、功能描述、非功能需求） |
| PRD-1.3 | 移除選料 | 可從已選清單移除某一項；存版後若來源被刪除，該區塊在 PRD 中保留內容但標註「來源已刪除」（見 9.3） |
| PRD-1.4 | 選料後觸發 AI | 按鈕「依選料生成 PRD 草稿」，呼叫 AI 將選料整理成大綱與章節一致的草稿，寫入目前編輯區 |

#### PRD-2 組裝區（草稿編輯）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| PRD-2.1 | 編輯器 | 富文本或 Markdown，章節可摺疊、可拖曳調整順序 |
| PRD-2.2 | 區塊來源標註 | 每個區塊可標註「來自 Intake #id / 會議記錄 #id / QA #id / Architecture #id」；顯示為小標或 tooltip，可點擊跳轉來源 |
| PRD-2.3 | 手動編輯 | 可任意增刪改內容，不影響來源資料；僅 PRD 自身版本變更 |
| PRD-2.4 | 存為新版本 | 按鈕「存為新版本」：將目前內容存成新版本號，可填版本備註（如 v1.1 更新範圍說明） |

#### PRD-3 版本管理

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| PRD-3.1 | 版本列表 | 列出所有版本：版本號、存版時間、備註；可選「當前對外」標記（僅一個） |
| PRD-3.2 | 版本 diff | 選兩版可並排或統一 diff 顯示差異 |
| PRD-3.3 | 還原 | 可將某版設為「目前編輯基底」或「還原到該版」（依產品決定是否覆寫工作區） |
| PRD-3.4 | 專案維度 | PRD 以專案為維度，每專案一套版本流 |

#### PRD-4 AI 建議（優化）

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| PRD-4.1 | 選料完成後建議章節 | 選料完成後，AI 可建議「建議章節結構」或「遺漏的參考來源」，使用者可採納或忽略 |
| PRD-4.2 | PRD 與 Story 對齊 | 某章節可連結到 Architecture 的某條 Story；雙向：PRD 顯示「對應 Story」，Story 顯示「被 PRD 章節 xxx 引用」 |

### 7.3 資料欄位（建議）

- PRD 主體：`id`, `projectId`, `currentVersionId`（目前工作區對應的版本，可選）.
- PRD 版本：`id`, `prdId`, `versionNumber`, `content`(html/md), `remark`, `savedAt`, `savedBy`, `isPublished`（是否為當前對外）.
- 選料快照（可選）：存某版本引用哪些來源 id，用於「來源已刪」時仍能顯示來自哪類型。

### 7.4 與他模組關聯

- **← Intake, MeetingNote, QA, Architecture**：選料來源；存版時可存引用 id 清單，用於標註與追溯。
- **→ Architecture / Story**：PRD 章節可連結 Story（雙向，見 AS-3.2、PRD-4.2）。

### 7.5 邊界與漏洞處理

- **漏洞 PRD-A**：選料中的某 Intake/QA 後被刪除，PRD 已存版內容如何？**決策**：PRD 內容保留；區塊標註改為「來源已刪除」，不提供連結（見 9.3）。
- **漏洞 PRD-B**：同一專案多人在線編輯 PRD？**決策**：先做「目前編輯基底 = 最後存版」；存版時若基底已變可提示「已有新版本，請重新載入再存」。

---

## 8. 跨功能與優化（整合進規格）

### 8.1 統一來源標註

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| 8.1.1 | 資料模型 | 凡可標註來源的實體（Intake, MeetingNote, QA, Architecture 條目, PRD 區塊）皆具 `sourceType` + `sourceId` 或等效關聯表 |
| 8.1.2 | UI 一致 | 各處顯示「來自 xxx」時格式一致（例如「來自會議：標題」／「來自 QA #12」），且可點擊跳轉（若來源仍存在） |

### 8.2 全域搜尋

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| 8.2.1 | 範圍 | 關鍵字可搜：File 檔名、Intake 逐字稿與分析、會議記錄/備忘錄標題與內文、QA 標題與描述、Architecture 條目、PRD 內容 |
| 8.2.2 | 結果呈現 | 結果依類型分組（檔案、Intake、會議記錄、QA、架構、PRD），每筆顯示標題與摘要，點擊跳轉至該筆詳情 |
| 8.2.3 | 篩選 | 可篩選「僅搜尋某幾類」、可選專案/時間範圍（若後端支援） |

### 8.3 時間軸／專案動態

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| 8.3.1 | 維度 | 以專案為維度，時間軸顯示：Intake 建立、會議記錄/備忘錄建立、QA 新增/狀態變更、Architecture 更新、PRD 存版 |
| 8.3.2 | 呈現 | 依時間倒序或正序，每條顯示類型圖示、標題、時間、可點擊進入詳情 |
| 8.3.3 | 篩選 | 可篩選「僅顯示某幾類事件」 |

### 8.4 會議記錄模板（已納入 4.2 MN-1）

- 見 MN-1.2、MN-1.3；模板種類與 AI 產出格式在實作時列舉。

### 8.5 PRD 與 Story 對齊（已納入 6.2 AS-3.2、7.2 PRD-4.2）

- Architecture 條目（Story）可被 PRD 章節連結；雙向顯示。

### 8.6 權限與可見範圍

| 子項 | 描述 | 驗收條件 |
|------|------|----------|
| 8.6.1 | 專案/空間 | 若系統有 Space/Project：File、Intake、會議記錄、QA、Architecture、PRD 皆可依專案（或空間）做篩選與存取控制 |
| 8.6.2 | 角色 | 可定義「僅檢視」「可編輯」「可刪除」等角色，套用在上述模組（實作時列舉權限矩陣） |

### 8.7 AI 建議（已分散至 IA-5、PRD-4）

- Intake 分析後建議 QA / Architecture；PRD 選料後建議章節與遺漏來源。

---

## 9. 漏洞與邊界清單（抓出並修正）

### 9.1 File 刪除與 Intake

- **漏洞**：刪除 File 後，Intake 仍存在，使用者從 Intake 想「下載原檔」會失敗。
- **修正**：File 刪除僅軟刪或硬刪檔案紀錄；Intake 不連動刪除。Intake 詳情若 `sourceFileId` 對應檔已刪，顯示「原始檔已刪除」，不顯示下載按鈕；File Records 列表不顯示已刪檔（或顯示為已刪除狀態）。

### 9.2 同一音檔重複分析

- **漏洞**：同一 File 多次觸發分析，產生多筆 Intake 時，列表可能重複感高。
- **修正**：規格明訂「每次分析產生新 Intake」或「同一 File 僅保留一筆 Intake 並覆寫」；若採前者，列表提供篩選「每檔僅顯示最新一筆」；若採後者，需定義「覆寫」為更新同一 Intake 的轉錄/分析內容。

### 9.3 PRD 選料來源被刪除

- **漏洞**：PRD 某版本引用了 Intake #5，之後 Intake #5 被刪除，PRD 區塊標註會失效。
- **修正**：存版時可快照「引用 id 清單」；顯示時若來源已刪，區塊保留內容，標註改為「來源已刪除」或「來源：Intake（已刪除）」，不提供連結。搜尋與報表不因來源刪除而丟失 PRD 內容。

### 9.4 Intake 刪除與下游

- **漏洞**：刪除 Intake 後，已產生的會議記錄、已加入的 QA、已寫入的 Architecture 條目會變成「來源失效」。
- **修正**：Intake 刪除採軟刪；會議記錄/備忘錄、QA、Architecture 保留並保留 `sourceIntakeId`；各處顯示「來源 Intake 已刪除」或隱藏連結。不級聯刪除下游，避免誤刪大量資料。

### 9.5 QA 刪除與會議記錄標註

- **漏洞**：會議記錄標註了「對應 QA #3」，若 QA #3 被刪除，會議記錄上的連結失效。
- **修正**：QA 軟刪除；會議記錄保留 `linkedQAItemId`；若 QA 已刪，顯示「對應 QA（已刪除）」或隱藏連結。同 9.3 原則。

### 9.6 專案刪除或歸檔

- **漏洞**：專案刪除或歸檔時，其下 Intake、QA、Architecture、PRD 如何處理？
- **修正**：規格明訂「專案軟刪除/歸檔時，子資料一併隱藏或唯讀」；不自動硬刪，以便還原或匯出。

### 9.7 並行編輯衝突

- **漏洞**：多人同時編輯同一 PRD 或同一 Architecture。
- **修正**：第一階段採「最後寫入覆蓋」+ 存版前檢查「基底版本」；若已變更提示重新載入。進階再考慮樂觀鎖或即時協作。

### 9.8 權限邊界

- **漏洞**：無權限者透過直接 API 存取他人專案資料。
- **修正**：所有 API 依 Space/Project 與角色做授權；列表與詳情皆過濾「僅可見範圍」；規格中明列「需實作授權中介層」。

---

## 10. 可執行階段規劃

### 10.1 階段劃分原則

- **Phase 1**：基礎實體與單模組可用（不強依賴他模組）。
- **Phase 2**：模組間關聯與關鍵流程（Intake → 會議記錄 / QA；QA → Architecture）。
- **Phase 3**：PRD 選料與 AI 整理、版本、diff；全域搜尋、時間軸、權限細化。

### 10.2 建議階段與依賴

| 階段 | 內容 | 依賴 | 產出可驗收 |
|------|------|------|------------|
| **P1-1** | File Records 強化：列表、篩選、搜尋、與 Intake 關聯標記（僅讀） | 現有 File + Intake 資料 | FR-1～FR-2、FR-4；IA 與 File 關聯查詢 |
| **P1-2** | Intake & Analysis 獨立列表與詳情頁：列表、詳情（逐字稿+分析）、狀態、來源 File 連結 | 現有轉錄/分析 API | IA-1、IA-2、IA-3；IA-4 僅 UI 佔位 |
| **P1-3** | 會議記錄與備忘錄：資料表、列表、建立（手動+從 Intake 一鍵生成）、編輯、存檔、關聯 Intake | Intake API | MN-1、MN-2、MN-3；模板至少 1～2 種 |
| **P1-4** | QA Backlog：資料表、CRUD、狀態、類型、列表與篩選、詳情；從 Intake「加入 QA」與雙向關聯 | 無 | QB-1～QB-4、QB-3.2 |
| **P2-1** | Intake 後續動作實作：一鍵會議記錄/備忘錄、加入 QA、建議寫入 Architecture（含 API） | P1-2、P1-3、P1-4 | IA-4 全；MN 與 Intake 雙向顯示 |
| **P2-2** | Architecture & Stories：專案維度、架構區/故事區、手動新增、從 Intake 建議、從 QA 結案同步、來源標註 | P1-4 | AS-1、AS-2、AS-3 |
| **P2-3** | 會議記錄與 QA 雙向標註：會議記錄標註「對應 QA」、QA 詳情顯示引用它的會議記錄 | P1-3、P1-4 | MN-1.7；QB-4.3 |
| **P2-4** | 統一來源標註與全域搜尋：資料模型補齊、搜尋 API、搜尋 UI | P1、P2 | 8.1、8.2 |
| **P3-1** | PRD：版本表、選料 UI、選料 API、組裝區編輯、存版、版本列表與 diff、還原 | P2-2 | PRD-1～PRD-3 |
| **P3-2** | PRD 選料來源整合：從 Intake/會議記錄/QA/Architecture 拉取選料、AI 整理草稿、區塊來源標註 | P3-1、P2 | PRD-1.4、PRD-2.2；9.3 處理 |
| **P3-3** | 時間軸／專案動態、PRD 與 Story 雙向連結、AI 建議（Intake 建議 QA/Arch、PRD 建議章節） | P2、P3-1 | 8.3、8.5、8.7；IA-5、PRD-4 |
| **P3-4** | 權限與可見範圍：專案/空間篩選、角色權限矩陣、API 授權 | 依現有登入與專案模型 | 8.6；9.8 |

### 10.3 任務對照表（章節 → 階段）

| 章節 | 對應階段 |
|------|----------|
| 2. File Records | P1-1 |
| 3. Intake & Analysis | P1-2, P2-1 |
| 4. 會議記錄與備忘錄 | P1-3, P2-1, P2-3 |
| 5. QA Backlog | P1-4, P2-1, P2-3 |
| 6. Architecture & Stories | P2-2 |
| 7. PRD | P3-1, P3-2, P3-3 |
| 8. 跨功能與優化 | P2-4, P3-3, P3-4 |
| 9. 漏洞與邊界 | 各階段實作時依 9.1～9.8 檢查 |

### 10.4 可並行項目

- P1-2（Intake 列表/詳情）與 P1-3（會議記錄）可並行。
- P1-4（QA Backlog）與 P1-3 可並行。
- P2-2（Architecture）與 P2-3（會議記錄↔QA）可並行。
- P3-3（時間軸、AI 建議）可與 P3-2 並行。

---

## 11. 附錄：狀態與類型列舉（建議）

### QA Backlog 狀態

- `pending` 待處理  
- `in_progress` 進行中  
- `done` 已結案  
- `on_hold` 擱置  

### QA Backlog 類型（可擴充）

- `requirement_confirmation` 需求確認  
- `contract` 合約  
- `idea` 發想  
- `payment` 請款  
- `to_discuss` 待討論  
- `follow_up` 跟進  
- `other` 其他  

### 會議記錄模板（初版）

- `general` 一般會議  
- `requirement_discussion` 需求討論  
- `contract_review` 合約確認  
- `sprint_retro` 衝刺回顧  

### Intake 狀態

- `processing` 處理中  
- `completed` 成功  
- `transcript_ok_analysis_failed` 轉錄成功分析失敗  
- `failed` 失敗  

---

（文件結束；實作時請依此拆成 API 規格、DB migration、前端路由與元件，並對應到本文件之子項編號以便追溯。）
